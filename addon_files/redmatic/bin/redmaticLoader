#!/bin/sh

CONF_DIR=/usr/local/etc/config
ADDON_DIR=/usr/local/addons/redmatic
WWW_DIR=/usr/local/etc/config/addons/www/redmatic

NODE=$ADDON_DIR/bin/node

export PATH=$ADDON_DIR/bin:$PATH
export HOME=$ADDON_DIR/home

export NO_UPDATE_NOTIFIER=true

RED_DIR=$ADDON_DIR/lib/node_modules/node-red
RED=$RED_DIR/red.js

SETTINGS=$ADDON_DIR/lib/settings.js

status=1
restarts=0
while [[ $status != 0 ]]; do
  echo $restarts > $ADDON_DIR/var/restart_count
  echo "Starting Node-RED" | logger -p daemon.info -t redmatic
  set -o pipefail
  $NODE $RED -s $SETTINGS 2>&1 | logger -p daemon.err -t node-red
  status=$?
  if [[ $status != 0 ]]; then
    echo "Node-RED exited with non-zero exit status $status" | logger -p daemon.err -t node-red
    let "restarts=restarts+1"
  fi
done

