#!/bin/sh

ADDONS_DIR=/usr/local/addons
RED_DIR=$ADDONS_DIR/redmatic
CONF_DIR=/usr/local/etc/config
WWW_DIR=$CONF_DIR/addons/www/redmatic

mount | grep /usr/local 2>&1 >/dev/null
if [ $? -eq 1 ]; then
  mount /usr/local
fi

mkdir -p $ADDONS_DIR && chmod 755 $ADDONS_DIR 
mkdir -p $WWW_DIR && chmod 755 $WWW_DIR
mkdir -p $CONF_DIR/lighttpd && chmod 755 $CONF_DIR/lighttpd

#
#   Stop service on update
#
if [ -f $CONF_DIR/rc.d/redmatic ]; then
    $CONF_DIR/rc.d/redmatic stop
fi

#
#   Install addon files
#
cp -af redmatic $ADDONS_DIR/

#
#   Migration from <= 1.0.0-beta.7
#
if [ -d $ADDONS_DIR/node-red ]; then

    if [ -f $CONF_DIR/rc.d/node-red ]; then
        rm $CONF_DIR/rc.d/node-red
    fi
    if [ -f $CONF_DIR/addons/www/check_update_node_red.cgi ]; then
        rm $CONF_DIR/addons/www/check_update_node_red.cgi
    fi
    if [ -f $CONF_DIR/lighttpd/node-red.conf ]; then
        rm $CONF_DIR/lighttpd/node-red.conf
    fi

    cp $ADDONS_DIR/node-red/var/flows.json $RED_DIR/var/flows.json

    rm -rf $ADDONS_DIR/node-red
fi

#
#   Migration from <= 1.0.0-beta.9
#
if [ -d $WWW_DIR ]; then
    rm -rf $WWW_DIR
fi
if [ -f $RED_DIR/lighttpd-error-503.html ]; then
    rm $RED_DIR/lighttpd-error-503.html
fi
if [ -f $RED_DIR/lighttpd.conf ]; then
    rm $RED_DIR/lighttpd.conf
fi
if [ -f $RED_DIR/logo-w-200.png ]; then
    rm $RED_DIR/logo-w-200.png
fi


#
#   Create default config on first install
#
if [ ! -f $RED_DIR/etc/settings.json ]; then
    mv $RED_DIR/etc/default-settings.json $RED_DIR/etc/settings.json
fi

#
#   Create example flows on first install
#
if [ ! -f $RED_DIR/var/flows.json ]; then
    mv $RED_DIR/var/example-flows.json $RED_DIR/var/flows.json
fi

#
#   Create Links
#
ln -sf $RED_DIR/www $WWW_DIR
ln -sf $RED_DIR/bin/redmatic $CONF_DIR/rc.d/redmatic
ln -sf $RED_DIR/etc/lighttpd.conf $CONF_DIR/lighttpd/redmatic.conf

#
#   Decompress git-core
#
tar -xzf $RED_DIR/libexec/git-core.tar.gz --directory $RED_DIR/libexec/
rm $RED_DIR/libexec/git-core.tar.gz

#
#   Create Buttons in Homematic WebUI
#
touch $CONF_DIR/hm_addons.cfg
./update_addon node-red node-red.cfg
./update_addon node-red-dashboard node-red-dashboard.cfg

sync
exit 0
