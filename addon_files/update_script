#!/bin/sh

ADDONS_DIR=/usr/local/addons
RED_DIR=$ADDONS_DIR/node-red
CONF_DIR=/usr/local/etc/config
WWW_DIR=$CONF_DIR/addons/www/redmatic

mount | grep /usr/local 2>&1 >/dev/null
if [ $? -eq 1 ]; then
  mount /usr/local
fi

mkdir -p $ADDONS_DIR && chmod 755 $ADDONS_DIR 
mkdir -p $WWW_DIR && chmod 755 $WWW_DIR

if [ -f $CONF_DIR/rc.d/node-red ]; then
    $CONF_DIR/rc.d/node-red stop
fi

if [ -f $RED_DIR/settings.js ]; then
    cp $RED_DIR/settings.js $RED_DIR/settings.js.old
fi

cp -af node-red $ADDONS_DIR/

mkdir -p $CONF_DIR/lighttpd
ln -sf $RED_DIR/lighttpd.conf $CONF_DIR/lighttpd/node-red.conf

chmod a+x $RED_DIR/node-red
ln -sf $RED_DIR/node-red $CONF_DIR/rc.d/node-red

if [ ! -f $RED_DIR/var/flows.json ]; then
    mv $RED_DIR/var/example-flows.json $RED_DIR/var/flows.json
fi

ln -s $RED_DIR/update_check.tcl $WWW_DIR/update_check.cgi
ln -s $RED_DIR/logo-w-200.png $WWW_DIR/logo-w-200.png

touch $CONF_DIR/hm_addons.cfg

./update_addon node-red node-red.cfg
./update_addon node-red-dashboard node-red-dashboard.cfg

sync

exit 0
